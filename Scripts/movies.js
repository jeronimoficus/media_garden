const notice=e=>new Notice(e,5e3),log=e=>console.log(e),API_KEY_OPTION="OMDb API Key",API_URL="https://www.omdbapi.com/",IMDB_BASE_URL="https://www.imdb.com/title/";let QuickAdd,Settings;async function start(e,t){QuickAdd=e,Settings=t;const i=await QuickAdd.quickAddApi.inputPrompt("Enter movie title or IMDB ID: ");if(!i)throw notice("No query entered."),new Error("No query entered.");let r;if(isImdbId(i))r=await getByImdbId(i);else{const e=await getByQuery(i),t=await QuickAdd.quickAddApi.suggester(e.map(formatTitleForSuggestion),e);if(!t)throw notice("No choice selected."),new Error("No choice selected.");r=await getByImdbId(t.imdbID)}QuickAdd.variables={...r,imdbUrl:IMDB_BASE_URL+r.imdbID,Released:formatDateString(r.Released),actorLinks:linkifyList(r.Actors.split(",")),genreLinks:linkifyList(r.Genre.split(",")),directorLink:linkifyList(r.Director.split(",")),fileName:replaceIllegalFileNameCharactersInString(r.Title),typeLink:`[[${"movie"===r.Type?"Movies":"Series"}]]`,languageLower:r.Language.toLowerCase()}}function isImdbId(e){return/^tt\d+$/.test(e)}function formatTitleForSuggestion(e){return`(${"movie"===e.Type?"M":"TV"}) ${e.Title} (${e.Year})`}function formatDateString(e){if(!e||"N/A"===e)return"";const t=e.split(" ");if(3!==t.length)return e;const[i,r,n]=t,o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(r);if(o<0)return e;const a=new Date(Number(n),o,Number(i));if(isNaN(a.getTime()))return e;return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}async function getByQuery(e){const t=await apiGet(API_URL,{s:e});if(!t.Search||!t.Search.length)throw notice("No results found."),new Error("No results found.");return t.Search}async function getByImdbId(e){const t=await apiGet(API_URL,{i:e});if(!t)throw notice("No results found."),new Error("No results found.");return t}function linkifyList(e){return Array.isArray(e)&&0!==e.length?1===e.length?`\n  - "[[${e[0].trim()}]]"`:e.map((e=>`\n  - "[[${e.trim()}]]"`)).join(""):""}function replaceIllegalFileNameCharactersInString(e){return e?e.replace(/[\\,#%&\{\}\/*<>$'\":@]/g,"").trim():""}async function apiGet(e,t){const i=new URLSearchParams;t&&Object.entries(t).forEach((([e,t])=>{null!=t&&""!==t&&i.append(e,String(t))}));const r=Settings?.["OMDb API Key"];if(!r||""===String(r).trim())throw notice("Please set your OMDb API key in the script settings."),new Error("Missing OMDb API key.");i.append("apikey",String(r).trim());const n=`${API_URL}?${i.toString()}`,o=await request({url:n,method:"GET",cache:"no-cache",headers:{"Content-Type":"application/json"}});return JSON.parse(o)}module.exports={entry:start,settings:{name:"Movie Script",author:"Christian B. B. Houmann",options:{[API_KEY_OPTION]:{type:"text",defaultValue:"",placeholder:"OMDb API Key"}}}};